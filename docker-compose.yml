version: "3.8"

services:
  clickhouse:
    image: clickhouse/clickhouse-server:24.8
    container_name: ch-server
    ports:
      - "8123:8123"   # HTTP
      - "9000:9000"   # Native TCP
    volumes:
      - ./clickhouse/init:/docker-entrypoint-initdb.d:ro
      - ch_data:/var/lib/clickhouse
    environment:
      - CLICKHOUSE_USER=vector
      - CLICKHOUSE_PASSWORD=vector
      - CLICKHOUSE_DB=observability
    healthcheck:
      test: ["CMD", "clickhouse-client", "-u", "vector", "--password", "vector", "--query=SELECT 1"]
      interval: 5s
      timeout: 5s
      retries: 10

  vector:
    image: timberio/vector:0.38.0-debian
    container_name: vector
    depends_on:
      clickhouse:
        condition: service_healthy
    volumes:
      - ./vector/vector.toml:/etc/vector/vector.toml:ro
      - ./alerts-only.json:/data/alerts-only.json
      - vector_data:/var/lib/vector
    environment:
      - VECTOR_LOG=info
    command: ["--config", "/etc/vector/vector.toml"]

  api:
    build:
      context: ./api
    container_name: alerts-api
    depends_on:
      clickhouse:
        condition: service_healthy
    environment:
      - ASPNETCORE_URLS=http://+:8080
    ports:
      - "8080:8080"

  web:
    build:
      context: ./web
    container_name: alerts-web
    ports:
      - "5173:5173"
    depends_on:
      - api
    environment:
      - VITE_API_URL=http://localhost:8080

volumes:
  ch_data:
  vector_data:
