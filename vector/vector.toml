data_dir = "/var/lib/vector"

[sources.alerts]
  type = "file"
  include = ["/data/eve.json"]
  fingerprinting.strategy = "device_and_inode"
  read_from = "beginning"

[transforms.normalize]
  type = "remap"
  inputs = ["alerts"]
  source = """
  # Store original message before parsing
  original_message = to_string!(.message)
  
  # Parse JSON from line
  evt = parse_json!(original_message)
  . = evt
  if .event_type != "alert" {
    abort
  }

  parsed_ts = now()
  ts_candidate, ts_err = parse_timestamp(.timestamp, format: "%FT%T%.f%z")
  if ts_err == null {
    parsed_ts = ts_candidate
  }

  severity = 0
  sev_val, severity_err = to_int(.alert.severity)
  if severity_err == null && sev_val != null {
    severity = sev_val
  }
  level = "INFO"
  if severity == 1 {
    level = "CRITICAL"
  } else if severity == 2 {
    level = "HIGH"
  } else if severity == 3 {
    level = "MEDIUM"
  } else if severity == 4 {
    level = "LOW"
  }

  signature = to_string(.alert.signature) ?? "Unknown alert"

  . = {
    "id": md5(to_string(.flow_id) ?? original_message),
    "ts": format_timestamp!(parsed_ts, format: "%Y-%m-%d %H:%M:%S"),
    "level": level,
    "message": signature,
    "payload": original_message,
    "source_file": "/data/eve.json",
    "source_offset": 0
  }
  """

[sinks.ch]
  type = "clickhouse"
  inputs = ["normalize"]
  database = "observability"
  table = "alerts"
  endpoint = "http://127.0.0.1:8123"
  skip_unknown_fields = true
  [sinks.ch.encoding]
    timestamp_format = "rfc3339"
